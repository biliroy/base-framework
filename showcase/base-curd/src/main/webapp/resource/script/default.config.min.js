(function($){
	var removeBackdrop = function(form){
		
		var backdrop = $(form.attr("data-backdrop"));
		
		if (backdrop.length === 0) {
			backdrop = form;
		}
		
		backdrop.find("div[for='"+form.attr("id")+"']").remove();
	};
	
	$.defaultAjaxFormSetting = {
			beforeSubmit:function(formData, jqForm, options){
				var fn = jqForm.attr("onbeforesubmit");
				
				if ($.isNotEmpty(fn) && window[fn](formData, jqForm, options) === false) {
					return false;
				}
				
				var backdrop = $(jqForm.attr("data-backdrop"));
				
				if (backdrop.length === 0) {
					backdrop = jqForm;
				}
				
				var mask = $("<div>").addClass("modal-backdrop fade in").attr("for",jqForm.attr("id"));
				backdrop.append(mask);
				
			},
			success:function(responseText, statusText, xhr, form){
				removeBackdrop(form);
				var fn = form.attr("onsuccess");
				if ($.isNotEmpty(fn)) {
					window[fn](responseText, statusText, xhr, form);
				}
			},
			error:function(response, statusText, message, form) {
				removeBackdrop(form);
				var fn = form.attr("onerror");
				if ($.isNotEmpty(fn)) {
					window[fn](response, statusText, message, form);
				}
			}
	};
	
	var initComponent = function(){
		$(".modal").on("shown.bs.modal",function(){
			$(this).find("form :input:not(:disabled):not(:hidden)").first().focus();
		});
		
		$("form[install!='true']").each(function(i,o){
			var temp = $(o);
			
			temp.find(":input:not(:disabled):not(:hidden)").first().focus();
			
			var id = temp.attr("id") || temp.attr("action").substring(temp.attr("action").indexOf("/") + 1,temp.attr("action").length);
			temp.attr("id",id.replace(/\//g,"-"));
			
			if ($.value(temp.attr("data-ajax-submit"),"false").booleanValue()) {
				temp.validate({
					submitHandler : function(form) {
						temp.ajaxSubmit($.defaultAjaxFormSetting);
					}
				});
			} else {
				temp.validate();
			}
			
			temp.find("button[type='reset']").click(function(){
				
				temp.find("input:not(:disabled):not(:hidden)").each(function(i,field){
					$(field).val("");
				});
				
				temp.find("select:not(:disabled):not(:hidden)").each(function(i,field){
					$(field).val("");
				});
				
				temp.find("textarea:not(:disabled):not(:hidden)").each(function(i,field){
					$(field).val("");
				});
				
				return false;
			});
			
			temp.attr("install",true);
		});
	};

	$.validator.setDefaults({
		showErrors : function(errorMap, errorList) {
			$.each(this.successList,function(i,e){
				var element = $(e);
				element.parent("div").removeClass("has-error");
				element.tooltip("destroy");
			});
			
			$.each(errorList, function(i, e) {
				var element = $(e.element);
				var tip = element.data('bs.tooltip');
				if ($.isNotEmpty(tip)) {
					tip.options.title = e.message;
					element.next().children(".tooltip-inner").html(e.message);
				} else {
					element.parent("div").addClass("has-error");
					element.tooltip({
						title:e.message,
						trigger:"focus"
					});
				}
			});
		}
	});
	
	$(document).ready(function(){
		
		var browser = function() {
	    	ua = navigator.userAgent.toLowerCase();
	
	    	var match = /(msie) ([\w.]+)/.exec( ua );
	
	    	return {
	    		name: $.isEmpty(match) ? "" : match[ 1 ] || "",
	    		version: $.isEmpty(match) ? "" : match[ 2 ] || "0"
	    	};
	    };
	    
	    if (browser().name === "msie" && browser().version < 8) {
	    	$(".main-container").html(
		    	'<div class="server-exception">' +
		    		'<p><center><img class="" src="resource/image/ie.png"></center></p>' +
		    		'<p>&nbsp;</p>' +
		    		'<h3>浏览器不兼容</h3>' +
		    		'<p>您的刘浏览器版本过低，<a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie">请升级IE到最新版本</a></p>' +
		    	'</div>'
	    	);
	    } else {
			initComponent();
	    }
	});
	
})(jQuery);
